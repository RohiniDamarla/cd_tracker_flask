<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CD Tracker</title>
  <style>
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #4CAF50; color: white; }
    button { margin: 2px; padding: 4px 8px; cursor: pointer; }
    .edit-btn { background-color: #2196F3; color: white; border: none; }
    .delete-btn { background-color: #f44336; color: white; border: none; }
    .save-btn { background-color: #4CAF50; color: white; border: none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  {% if current_user.is_authenticated %}
    <div style="text-align: right;">
      <span style="margin-right: 10px;">
        ðŸ‘‹ Welcome, {{ current_user.username }}!
        <a href="{{ url_for('logout') }}"> ðŸ”“ Logout</a>
        <a href="{{ url_for('add') }}"> âž• Add New CD</a>
      </span>
    </div>
  {% endif %}

<center><h2>CD Tracker</h2></center>

<table id="cdTable">
  <thead>
    <tr>
      <th>Bank</th>
      <th>Amount</th>
      <th>Rate (%)</th>
      <th>Start Date</th>
      <th>Maturity Date</th>
      <th>Notes</th>
      <th>Interest Earned</th>
      <th>Total Value</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for cd in cds %}
    <tr data-id="{{ cd.id }}">
      <td>
        <span class="bank-name" style="color:blue; cursor:pointer;">{{ cd.bank_name }}</span>
      </td>
      <td>{{ "%.2f"|format(cd.amount) }}</td>
      <td>{{ cd.interest_rate }}</td>
      <td>{{ cd.start_date.strftime('%Y-%m-%d') }}</td>
      <td>{{ cd.maturity_date.strftime('%Y-%m-%d') }}</td>
      <td>{{ cd.notes or '' }}</td>
      <td>{{ "%.2f"|format(cd.interest) }}</td>
      <td>{{ "%.2f"|format(cd.total_value) }}</td>
      <td>
        <button class="edit-btn" onclick="editRow(this)">Edit</button>
        <button class="delete-btn" onclick="deleteRow(this)">Delete</button>
      </td>
    </tr>
    <tr class="chart-row" style="display:none;">
      <td colspan="9">
        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
          <canvas id="bar-chart-{{ cd.id }}" width="400" height="200"></canvas>
          <canvas id="line-chart-{{ cd.id }}" width="400" height="200"></canvas>
          <canvas id="pie-chart-{{ cd.id }}" width="200" height="200"></canvas>
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
function editRow(btn) {
  let row = btn.parentNode.parentNode;
  let cells = row.querySelectorAll("td");
  if (btn.textContent === "Edit") {
    for (let i = 0; i < 6; i++) {
      let val = cells[i].innerText;
      cells[i].innerHTML = `<input type="text" value="${val}">`;
    }
    btn.textContent = "Save";
    btn.className = "save-btn";
  } else {
    let cdId = row.getAttribute("data-id");
    let data = {
      bank_name: cells[0].querySelector("input").value,
      amount: cells[1].querySelector("input").value,
      interest_rate: cells[2].querySelector("input").value,
      start_date: cells[3].querySelector("input").value,
      maturity_date: cells[4].querySelector("input").value,
      notes: cells[5].querySelector("input").value
    };

    fetch(`/update/${cdId}`, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams(data)
    }).then(() => {
      for (let i = 0; i < 6; i++) {
        cells[i].innerText = data[Object.keys(data)[i]];
      }
      btn.textContent = "Edit";
      btn.className = "edit-btn";
      location.reload();
    });
  }
}

function deleteRow(btn) {
  let row = btn.parentNode.parentNode;
  let cdId = row.getAttribute("data-id");

  fetch(`/delete/${cdId}`, {
    method: "POST"
  }).then(() => {
    row.remove();
  });
}

document.querySelectorAll('.bank-name').forEach((el) => {
  el.addEventListener('click', () => {
    const row = el.closest('tr');
    const chartRow = row.nextElementSibling;
    chartRow.style.display = chartRow.style.display === 'none' ? '' : 'none';

    const cdId = row.getAttribute('data-id');
    const amount = parseFloat(row.children[1].innerText);
    const rate = parseFloat(row.children[2].innerText);
    const startDate = new Date(row.children[3].innerText);
    const maturityDate = new Date(row.children[4].innerText);

    const labels = [];
    const data = [];

    let currentDate = new Date(startDate);
    while (currentDate <= maturityDate) {
      const monthsElapsed = (currentDate.getFullYear() - startDate.getFullYear()) * 12 +
                            (currentDate.getMonth() - startDate.getMonth());
      const years = monthsElapsed / 12;
      const interest = amount * (rate / 100) * years;
      const total = amount + interest;

      const label = `${currentDate.toLocaleString('default', { month: 'short' })} ${currentDate.getFullYear()}`;
      labels.push(label);
      data.push(parseFloat(total.toFixed(2)));

      currentDate.setMonth(currentDate.getMonth() + 1);
    }

    const barCanvas = document.getElementById(`bar-chart-${cdId}`);
    const lineCanvas = document.getElementById(`line-chart-${cdId}`);
    const pieCanvas = document.getElementById(`pie-chart-${cdId}`);

    if (!barCanvas.dataset.rendered) {
      new Chart(barCanvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total Value ($)',
            data: data,
            backgroundColor: '#4CAF50'
          }]
        },
        options: {
          scales: {
            x: {
              title: { display: true, text: 'Month-Year' },
              ticks: { autoSkip: false, maxRotation: 90, minRotation: 45 }
            },
            y: {
              title: { display: true, text: 'Total Value ($)' },
              beginAtZero: true
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'CD Growth Over Time (Bar Chart)'
            },
            legend: { display: false }
          }
        }
      });

      new Chart(lineCanvas, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total Value ($)',
            data: data,
            borderColor: '#FF5722',
            fill: false,
            tension: 0.3
          }]
        },
        options: {
          scales: {
            x: {
              title: { display: true, text: 'Month-Year' },
              ticks: { autoSkip: false, maxRotation: 90, minRotation: 45 }
            },
            y: {
              title: { display: true, text: 'Total Value ($)' },
              beginAtZero: true
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'CD Value Growth (Line Chart)'
            }
          }
        }
      });

      const finalValue = data[data.length - 1];
      const interestEarned = finalValue - amount;

      new Chart(pieCanvas, {
        type: 'pie',
        data: {
          labels: ['Principal', 'Interest'],
          datasets: [{
            data: [amount, interestEarned],
            backgroundColor: ['#4CAF50', '#2196F3']
          }]
        },
        options: {
          plugins: {
            title: {
              display: true,
              text: 'Principal vs Interest at Maturity'
            }
          }
        }
      });

      barCanvas.dataset.rendered = true;
      lineCanvas.dataset.rendered = true;
      pieCanvas.dataset.rendered = true;
    }
  });
});
</script>
</body>
</html>